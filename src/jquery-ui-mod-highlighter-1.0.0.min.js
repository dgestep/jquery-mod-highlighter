(function($,undefined){var classModHighlighterContainer="hasModificationHighlighter";var panelsIgnoreModified="panels-ignore-modified";var panelsEvaluateModified="panels-evaluate-modified";var classTrackerInputModifiable="tracker-input-modifiable";var dataTrackerOriginalValue="data-tracker-original-value";$.widget("dtg.modificationHighlighter",{options:{addlSelectableInputTypes:'',inputNotModifiedIfHasClass:'error',modifiedColumnClass:"ui-state-highlight",modifiedLabelClass:"ui-state-highlight"},_create:function(){if(this.element.hasClass(classModHighlighterContainer)){return}this.storeOriginalValues(this.element.id);if(!this.element.hasClass(classModHighlighterContainer)){this.element.addClass(classModHighlighterContainer)}},_setOption:function(key,value){this.options[key]=value},getModifiedColumns:function(containerId){var columns=[];var withClasses=[];withClasses.push(this.options.modifiedColumnClass);withClasses.push(this.options.inputNotModifiedIfHasClass);var selector=this._createSelectorForInputTypes(containerId,withClasses);var plugin=this;$(selector).each(function(event){var inp=$(this);if(plugin._isRadioButton(inp)){if(!inp.is(':checked')){return true}}var originalValue=inp.data(dataTrackerOriginalValue);var currentValue=plugin._getValueOfInput(inp);var id=plugin._getKeyForInputValueStorage(inp);var labelText=plugin._getLabelTextForInputId(id);var column=plugin._createColumnStructure(id,currentValue,originalValue,labelText);columns.push(column)});return columns},getAllColumnsWithSuppliedClass:function(containerId,className){var columns=[];if(this._isNullOrUndefined(className)){return columns}var withClasses=[];withClasses.push(className);var selector=this._createSelectorForInputTypes(containerId,withClasses);var plugin=this;$(selector).each(function(event){var inp=$(this);var originalValue=inp.data(dataTrackerOriginalValue);var currentValue=plugin._getValueOfInput(inp);var id=plugin._getKeyForInputValueStorage(inp);var labelText=plugin._getLabelTextForInputId(id);var column=plugin._createColumnStructure(id,currentValue,originalValue,labelText);columns.push(column)});return columns},getStoredInputValue:function(containerId,searchColumnId){var columns=this.getStoredInputColumns(containerId);var foundColumn=null;for(var i=0;i<columns.length;i++){var column=columns[i];if(column.id==searchColumnId){foundColumn=column;break}}return foundColumn},getStoredInputColumns:function(containerId){var columns=[];var withClasses=[];withClasses.push(classTrackerInputModifiable);var selector=this._createSelectorForInputTypes(containerId,withClasses);var plugin=this;$(selector).each(function(){var inp=$(this);var val=inp.data(dataTrackerOriginalValue);if(val!=null){var column=plugin._createAndPopulateColumnStructure(inp);columns.push(column)}});return columns},_createAndPopulateColumnStructure:function(inp){var originalValue=inp.data(dataTrackerOriginalValue);var currentValue=this._getValueOfInput(inp);var id=this._getKeyForInputValueStorage(inp);var labelText=this._getLabelTextForInputId(id);return this._createColumnStructure(id,currentValue,originalValue,labelText)},_createColumnStructure:function(id,currentValue,originalValue,labelText){var s={'id':id,'value':currentValue,'originalValue':originalValue,'label':labelText};return s},reset:function(containerId){var brmc=$.Event("beforeResetModifiedColumns");this._trigger("beforeResetModifiedColumns",brmc,{'element':this.element,'containerId':containerId});if(brmc.isDefaultPrevented()){return}var columns=this.getModifiedColumns(containerId);for(var i=0;i<columns.length;i++){var column=columns[i];var inp=this._findInputObjectByColumn(containerId,column.id);var rmci=$.Event("resetModifiedColumnsIteration");this._trigger("resetModifiedColumnsIteration",rmci,{'element':this.element,'column':column,'input':inp,'index':i});if(rmci.isDefaultPrevented()){continue}if(this._isCheckBox(inp)){if(column.originalValue=="true"){inp.attr("checked","checked")}else{inp.removeAttr("checked")}inp.trigger("change");continue}if(this._isRadioButton(inp)){var name=column.id;var radioColumn=this.getStoredInputValue(containerId,name);if(radioColumn!=null){var originalValue=radioColumn.originalValue;this._resetRadio(inp,originalValue);inp.trigger("change")}continue}inp.val(column.originalValue);inp.removeClass(this.options.inputNotModifiedIfHasClass);inp.trigger("change")}var armc=$.Event("afterResetModifiedColumns");this._trigger("afterResetModifiedColumns",armc,{'element':this.element,'containerId':containerId})},_findInputObjectByColumn:function(containerId,id){var inp=$(this._formatSelectorForContainerId(containerId)+" "+this._prepId(id));if(inp.length==0){var name=this._escapeValue(id);if(this._isNullOrUndefined(containerId)){inp=$("[name="+name+"]")}else{inp=$(this._prepId(containerId)+" [name="+name+"]")}}return inp},storeOriginalValues:function(containerId){this._defineChangeEvent(containerId);var selector=this._createSelectorForInputTypes(containerId,null);var plugin=this;$(selector).each(function(){var inp=$(this);var ignoreModified=plugin._isExceptionToRule(inp,panelsIgnoreModified,panelsEvaluateModified);if(ignoreModified){return true}if(plugin._isRadioButton(inp)){if(!inp.is(':checked')){plugin._setInputAsNotModified(inp)inp.removeData(dataTrackerOriginalValue);return true}}if(plugin._isWorthyOfStorage(inp)){var val=plugin._getValueOfInput(inp);inp.data(dataTrackerOriginalValue,val);inp.addClass(classTrackerInputModifiable);inp.trigger("change")}})},setOriginalValues:function(columns){if(this._isNullOrUndefined(columns)||columns.length==0){return}for(var i=0;i<columns.length;i++){var column=columns[i];var inp=this._findInputObjectByColumn(containerId,column.id);inp.data(dataTrackerOriginalValue,column.originalValue);inp.trigger("change")}},_defineChangeEvent:function(containerId){var selector=this._createSelectorForInputTypes(containerId,null);var plugin=this;$(selector).on("change",function(event){var inp=$(this);if(plugin._isIgnoreChange(inp)){return true}if(plugin._isModified(inp)){plugin._setInputAsModified(inp)}else{plugin._setInputAsNotModified(inp)}var ac=$.Event("afterChange");plugin._trigger("afterChange",ac,{'element':this.element,'input':inp})})},_createSelectorForInputTypes:function(containerId,withClasses){var selector=this._formatSelectorForContainerId(containerId);if(this._isNullOrUndefined(withClasses)){withClasses=[];withClasses.push("")}var addlSelectableInputTypes=$.trim(this.options.addlSelectableInputTypes);var inputTypes="";for(var i=0;i<withClasses.length;i++){var withClass=withClasses[i];if(withClass!=""){withClass="."+withClass}if(i>0){inputTypes+=", "}inputTypes+=this._getSelectableInputTypes(selector,addlSelectableInputTypes,withClass)}return inputTypes},_formatSelectorForContainerId:function(containerId){var panelId=this.element.attr("id");if(panelId==containerId){containerId=null}var selector='#'+containerId+' ';if(this._isNullOrUndefined(containerId)){selector=''}if(selector==''){selector='#'+panelId}else{selector='#'+panelId+' '+selector}return selector+' '},_getSelectableInputTypes:function(selector,addlSelectableInputTypes,withClass){var inputs=null;var defaultTypes='input:text,input:checkbox,input:radio,input[type=email],select,textarea'.split(",");var addl=null;if(addlSelectableInputTypes.length>0){addl=addlSelectableInputTypes.split(",");inputs=defaultTypes.concat(addl)}else{inputs=defaultTypes}var types=[];for(var i=0;i<inputs.length;i++){var input=$.trim(inputs[i]);var s=selector+input+withClass+", ";types.push(s)}var all=types.join('');var idx=all.lastIndexOf(", ");return all.substring(0,idx)},_isIgnoreChange:function(inp){var errorClass=this.options.inputNotModifiedIfHasClass;if(errorClass!=''&&inp.hasClass(errorClass)){return true}if(this._isExceptionToRule(inp,panelsIgnoreModified,panelsEvaluateModified)){return true}return false},_isExceptionToRule:function(inp,exceptionToRuleClass,evaluateAnywayClass){var exceptionToRule=inp.hasClass(exceptionToRuleClass);if(exceptionToRule){return true}var evaluateAnyway=this._isNotNullAndNotUndefined(evaluateAnywayClass)&&inp.hasClass(evaluateAnywayClass);if(!evaluateAnyway){var p=inp.parents("."+exceptionToRuleClass);if(p.length>0){return true}}return false},_getKeyForInputValueStorage:function(inp){var name=inp.attr("id");if(this._isNullOrUndefined(name)||this._isRadioButton(inp)){name=inp.attr("name")}return name},_setInputAsModified:function(inp){if(this._isRadioButton(inp)){this._highlightRadio(inp,true)}else{inp.addClass(this.options.modifiedColumnClass);var label=this._getLabelForInput(inp);if(label!=null&&label.length>0){label.addClass(this.options.modifiedLabelClass)}}var miam=$.Event("markInputAsModified");this._trigger("markInputAsModified",miam,{'element':this.element,'input':inp})},_highlightRadio:function(inp,highlight){var plugin=this;var name=this._getKeyForInputValueStorage(inp);var panelId="#"+this.element.attr("id")+" input[name="+this._escapeValue(name)+"]";$(panelId).each(function(index){var radioInp=$(this);if(highlight){radioInp.addClass(plugin.options.modifiedColumnClass)}else{radioInp.removeClass(plugin.options.modifiedColumnClass)}var id=radioInp.attr("id");if(plugin._isNotNullAndNotUndefined(id)){var label=plugin._getLabelById(id);if(label!=null&&label.length>0){if(highlight){label.addClass(plugin.options.modifiedLabelClass)}else{label.removeClass(plugin.options.modifiedLabelClass)}}}})},_setInputAsNotModified:function(inp){if(this._isRadioButton(inp)){this._highlightRadio(inp,false)}else{inp.removeClass(this.options.modifiedLabelClass);var label=this._getLabelForInput(inp);if(label!=null&&label.length>0){label.removeClass(this.options.modifiedLabelClass)}}var mianm=$.Event("markInputAsNotModified");this._trigger("markInputAsNotModified",mianm,{'element':this.element,'input':inp})},_getLabelForInput:function(inp){var id=this._getKeyForInputValueStorage(inp);var label=this._getLabelById(id);if(label.length==0){id=inp.attr("id");if(this._isNotNullAndNotUndefined(id)){label=this._getLabelById(id)}}return label},_getLabelById:function(id){if(this._isNullOrUndefined(id)){return null}var panelId=this.element.attr("id");var escapedId=this._escapeValue(id);var label=$("#"+panelId+" label[for="+escapedId+"]");return label},_getLabelTextForInputId:function(id){var labelText="";var label=this._getLabelById(id);if(label!=null&&label.length>0){labelText=label.text()}return labelText},_isModified:function(inp){var modified=false;var originalValue=inp.data(dataTrackerOriginalValue);var currentValue=this._getValueOfInput(inp);var radio=this._isRadioButtonAndChecked(inp);if(radio&&originalValue==null&&currentValue!=null){modified=true}else{modified=this._isNotNullAndNotUndefined(originalValue)&&originalValue.toString()!=currentValue.toString()}var im=$.Event("isInputModified");var data={'element':this.element,'input':inp,'modified':modified};this._trigger("isInputModified",im,data);modified=data.modified;return modified},_isRadioButtonAndChecked:function(inp){return this._isRadioButton(inp)&&this._isChecked(inp)},_isChecked:function(inp){var chk=inp.attr("checked");return chk!=undefined&&chk!=false},_isRadioButton:function(inp){return inp.attr("type")=="radio"},_resetRadio:function(inp,searchValue){for(var i=0;i<inp.length;i++){var radio=$(inp[i]);if(radio.val()==searchValue){radio.attr("checked","checked");break}}},_isWorthyOfStorage:function(inp){var name=this._getKeyForInputValueStorage(inp);return this._isNotNullAndNotUndefined(name)&&name.length>0},_getValueOfInput:function(inp){var val="";if(this._isCheckBox(inp)){if(inp.is(':checked')){val="true"}else{val="false"}}if(val==""){val=inp.val();if(val==null){val=""}}return val},_isCheckBox:function(inp){return inp.attr("type")=="checkbox"},_prepId:function(id){if(this._isNullOrUndefined(id)){return""}if(id.indexOf("#")<0){id="#"+id}return id},_isNullOrUndefined:function(obj){return obj==null||obj==undefined},_isNotNullAndNotUndefined:function(obj){return obj!=undefined&&obj!=null},_escapeValue:function(str){str=str.replace(/\+/g,"\\+");str=str.replace(/\\/g,"\\");str=str.replace(/\//g,"\\/");str=str.replace(/!/g,"\\!");str=str.replace(/"/g,'\\"');str=str.replace(/#/g,"\\#");str=str.replace(/\$/g,"\\$");str=str.replace(/%/g,"\\%");str=str.replace(/&/g,"\\&");str=str.replace(/'/g,"\\'");str=str.replace(/\(/g,"\\(");str=str.replace(/\)/g,"\\)");str=str.replace(/\*/g,"\\*");str=str.replace(/,/g,"\\,");str=str.replace(/\./g,"\\.");str=str.replace(/:/g,"\\:");str=str.replace(/;/g,"\\;");str=str.replace(/\?/g,"\\?");str=str.replace(/@/g,"\\@");str=str.replace(/\[/g,"\\[");str=str.replace(/\]/g,"\\]");str=str.replace(/\^/g,"\\^");str=str.replace(/`/g,"\\`");str=str.replace(/\{/g,"\\{");str=str.replace(/\}/g,"\\}");str=str.replace(/\|/g,"\\|");str=str.replace(/\~/g,"\\~");return str},});$.extend($.dtg.modificationHighlighter,{version:"1.0.0"})}(jQuery));